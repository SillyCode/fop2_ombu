#!/bin/sh

# The common part of the post-install script for packages

set -e

if [ -e /etc/debian_version ]; then
	mysql_service="mysql"
	apache_user="www-data"
else
	mysql_service="mariadb"
	apache_user="apache"
fi

webadmin_secret_file="/etc/fop2/webadmin/admin_dbpass.php"

generate_manager_secret() {
	local secret_file=/etc/asterisk/ombutel/manager__60-fop2_secret.conf
	if [ -e "$secret_file" ]; then
		return
	fi
	local secret=`head -c 64 /dev/urandom | md5sum | cut -c 1-20`
	cat <<EOF >"$secret_file"
[fop2](+)
; A generated file with only the secret. The rest goes in
; manager__60-fop2.conf . Do not edit this file unless you wish to change
; the password.
secret = $secret
EOF
	chown fop2:asterisk "$secret_file"
	chmod 640 "$secret_file"
}

generate_webadmin_secret() {
	if [ -e "$webadmin_secret_file" ]; then
		return
	fi
	local secret=`head -c 64 /dev/urandom | md5sum | cut -c 1-20`
	mkdir -p "${webadmin_secret_file%/*}"
	cat <<EOF >"$webadmin_secret_file"
<?php
\$DBPASS = "$secret";
?>
EOF
	chown $apache_user "$webadmin_secret_file"
	chmod 400 "$webadmin_secret_file"
}

create_webadmin_db() {
	# FIXME: handle the case of MySQL not running?
	# This is less critical, so in case of a problem, reconfigure the
	# package
	mysql_cmd="mysql -B -N"
	local dbname='fop2'
	local dbuser='fop2'
	if ! systemctl --quiet is-active ${mysql_service}.service; then
		return
	fi
	if $mysql_cmd -e 'show databases' | grep "^$dbname$"; then
		return
	fi
	local secret=`awk -F'"' '/DBPASS/ {print $2}' "$webadmin_secret_file"`
	cat <<EOF | $mysql_cmd
CREATE DATABASE $dbname;
GRANT ALL ON $dbname.* to '$dbuser'@'localhost' identified by '$secret';
EOF
}

set_sqlite_permissions() {
	local sqlite_file="/etc/fop2/fop2settings.db"
	local sqlite_dir="${sqlite_file%/*}"
	mkdir -p "$sqlite_dir"
	touch "$sqlite_file"
	chown fop2 "$sqlite_dir" "$sqlite_file"
	# Allow Apache to write to the database as well:
	setfacl -m u:$apache_user:rwx "$sqlite_dir"
	setfacl -m u:$apache_user:rw  "$sqlite_file"
}

generate_manager_secret
generate_webadmin_secret
create_webadmin_db
set_sqlite_permissions
